name: Generate llms.txt

on:
  workflow_call:
    inputs:
      release_version:
        description: 'Release version (if triggered from release workflow)'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (optional)'
        required: false
        type: string
  push:
    branches:
      - main
    paths:
      - 'skills/**'
      - 'scripts/generate-llms.ts'
      - 'package.json'

jobs:
  generate-llms:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate llms.txt
        run: npm run generate-llms

      - name: Check for changes
        id: check-changes
        run: |
          git add llms.txt || true
          if git diff --cached --quiet llms.txt; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to llms.txt"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "llms.txt has been updated"
            git diff --cached llms.txt || git diff llms.txt
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update llms.txt with latest skills index'
          title: 'chore: Update llms.txt with latest skills index'
          body: |
            This PR automatically updates `llms.txt` with the latest skills index.

            **Changes:**
            - Regenerated llms.txt from skills directory
            - Includes all SKILL.md files, references, examples, and scripts

            **Generated by:** GitHub Actions workflow
            **Triggered by:** ${{ github.event_name }}
            ${{ inputs.release_version && format('**Release Version:** {0}', inputs.release_version) || '' }}
          branch: update-llms-txt-${{ github.run_id }}-${{ github.run_attempt }}
          delete-branch: true
          labels: |
            automated
            documentation
